---
title: "Alice's TEMPEST litter analysis"
author: "AES"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(readr)
library(lubridate)
library(dplyr)
library(ggplot2)
theme_set(theme_bw())
```

## Read in Data

```{r read-data}
litter <- read_csv("TEMPEST litter data - Masses.csv", 
                   skip = 1, show_col_types = FALSE) 
## convert date collected column into an actual date format
litter$Date_collected <- mdy(litter$Date_collected)
## drop columns we don't care about
litter$Collection_Year <- litter$Collection_DOY <- 
  litter$Date_sorted <- litter$Date_entered <- 
  litter$Entered_by <- litter$Notes <- NULL

message("data read ok! rows = ", nrow(litter))
```

## Calculate/fill in All-Leaf column

```{r fill all leaf}
## if else means; condition is na is all leaf; if true add species and put in all leaf; if false use what is in all leaf
litter %>% 
  mutate(All_Leaf = if_else(condition = is.na(All_Leaf),
                            true = Leaf_ACRU + Leaf_FAGR + Leaf_LITU + Leaf_Other,
                            false = All_Leaf)) ->
  litter

```

## Turn these collection masses into daily fluxes
## Step 1: Calculate how long it's been since the last collection
## Step 2: Divide leaf litter biomass by the time computed in Step 1

```{r}
# for each plot and trap we want to compute the days

litter %>%
  group_by(Plot, Trap) %>% 
  arrange(Date_collected) %>%
  # compute the difference between collection dates. For a series of
  # size n, diff() returns n-1 intervals, so we add one NA at the front
  # because the first date has no elapsed time (since no previous date)
  mutate(elapsed_days = c(NA, diff(Date_collected))) %>% 
  ungroup() %>%
  arrange(Plot, Trap) %>% 
  ## finally compute flux: litter per day
  mutate(All_Leaf_perday = All_Leaf / elapsed_days) ->
  litter

```

## Step 3: Interpolate rates between collection dates

```{r}

## to interpolate between two dates, we need to create empty rows
## for example, if we collected on 10/1 and 10/10 right now we only have those rows in our data set
## so we need to create rows from 10/2 . . . 10/9 and then interpolate between the 10/1 flux and 10/10 flux to fill in those rows
## we will use complete() to generate the non-measured intervening dates
## and then we will use zoo::na.approx() to interpolate

# Date example
test <- tibble(day = mdy(c("10/20/2021", "10/31/2021")),
               values = c(60, 97))
test %>% 
  complete(day = seq(min(day), max(day), by = "day")) %>% 
  mutate(values = na.approx(values))

# Examine: just the control 'A' trap in 2019
litter %>% 
  filter(Plot == "C", Trap == "A", year(Date_collected) == 2019) %>% 
  select(Plot, Trap, Date_collected, All_Leaf) ->
  litter_C_A_example

# For today:
# 1. Go over the benefit of working with a small test dataset

# Generate between first and last collection dates
days_wanted <- seq(from = min(litter_C_A_example$Date_collected), 
                   to = max(litter_C_A_example$Date_collected), 
                   by = "day")

# Generate for the entire year
days_wanted <- seq(from = ymd ("2019-01-01"), 
                   to = ymd ("2019-12-31"), 
                   by = "day")

# For all combination of plot and trap we want all days for all combinations of plot and trap

litter_C_A_example %>%
  complete(Plot, Trap, Date_collected = days_wanted) %>%
  mutate(All_Leaf = na.approx(All_Leaf, na.rm = FALSE)) ->
  litter_C_A_2019

# Visualize our example control A 2019 data

ggplot(litter_C_A_2019, aes(x = Date_collected, y = All_Leaf)) +
  geom_point()


```

```{r}
## attempt to graph Control trap A over all years

litter %>% 
  filter(Plot == "C", Trap == "A") %>% 
  select(Plot, Trap, Date_collected, All_Leaf) ->
  litter_C_A_allyears

# not sure I need the below ??
# TODO: talk about this
days_wanted <- seq(from = min(litter_C_A_allyears$Date_collected), 
                   to = max(litter_C_A_allyears$Date_collected), 
                   by = "day")

# do need this:
# TODO: talk about this
days_wanted <- seq(from = ymd ("2018-11-08"), 
                   to = ymd ("2024-12-31"), 
                   by = "day")


litter_C_A_allyears %>%
  complete(Plot, Trap, Date_collected = days_wanted) %>%
  mutate(All_Leaf = na.approx(All_Leaf,na.rm = FALSE)) ->
  litter_C_A_daily

ggplot(litter_C_A_daily,aes(x = Date_collected, y = All_Leaf)) + geom_point()

```

```{r}
# Graph all traps in salt plot interpolated

litter %>% 
  filter(Plot == "S") %>% 
  select(Plot, Trap, Date_collected, All_Leaf) ->
  litter_S_alltraps

litter_S_alltraps %>%
  # TODO: talk about this
  complete(Plot, Trap, Date_collected = days_wanted) %>%
  mutate(All_Leaf = na.approx(All_Leaf, na.rm = FALSE)) ->
  litter_S_daily

ggplot(litter_S_daily,aes(x = Date_collected, y = All_Leaf, color = Trap)) +
  geom_point()

```


## Step 4: We want to compute cumulative litter fall across the year

## Basic Visualization

```{r basicvis, echo=FALSE}
library(ggplot2)

## plot biomass

ggplot(data = litter, aes(Date_collected, Leaf_LITU, color = Plot)) + geom_point(na.rm = TRUE)

ggplot(data = litter, aes(Date_collected, Leaf_ACRU, color = Plot)) + geom_point(na.rm = TRUE)

ggplot(data = litter, aes(Date_collected, Leaf_FAGR, color = Plot)) + geom_point(na.rm = TRUE)

ggplot(data = litter, aes(Date_collected, Leaf_Other, color = Plot)) + geom_point(na.rm = TRUE)

ggplot(data = litter, aes(Date_collected, All_Leaf, color = Plot)) + geom_point(na.rm = TRUE)

##  plot flux

ggplot(data = litter, aes(Date_collected, All_Leaf_perday, color = Plot)) + geom_point(na.rm = TRUE)

```

## Species average over time

```{r}
library(tidyr)
litter %>%
  group_by(Plot, Date_collected) %>%
  summarise(Leaf_ACRU = mean(Leaf_ACRU, na.rm = TRUE), 
            Leaf_FAGR = mean(Leaf_FAGR, na.rm = TRUE),
            Leaf_LITU = mean(Leaf_LITU, na.rm = TRUE),
            Leaf_Other = mean(Leaf_Other, na.rm = TRUE), .groups = "drop") %>%
  pivot_longer(starts_with("Leaf_")) ->
  litter_smry

ggplot(litter_smry, aes(Date_collected, value, color = Plot)) + geom_line() + facet_grid(name ~ .)

```

## 

