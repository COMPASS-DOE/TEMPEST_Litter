---
title: "Alice's TEMPEST litter analysis"
author: "AES"
date: "2025-10-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(readr)
library(lubridate)
library(dplyr)
```

## Read in Data

```{r read-data}
litter <- read_csv("TEMPEST litter data - Masses.csv", skip = 1, show_col_types = FALSE) 
## convert date collected column into an actual date format
litter$Date_collected <- mdy(litter$Date_collected)
## drop columns we don't care about
litter$Collection_Year <- litter$Collection_DOY <- litter$Date_sorted <- 
  litter$Date_entered <- litter$Entered_by <- litter$Notes <- NULL

message("data read ok! rows = ", nrow(litter))
```

## Calculate/fill in All-Leaf column

```{r fill all leaf}
## if else means; condition is na is all leaf; if true add species and put in all leaf; if false use what is in all leaf
litter %>% 
  mutate(All_Leaf = if_else(condition = is.na(All_Leaf),
                            true = Leaf_ACRU + Leaf_FAGR + Leaf_LITU + Leaf_Other,
                            false = All_Leaf)) ->
  litter

```

## For next time, we want to turn these collection masses into daily fluxes
## Step 1: We want to know how long its been since the last collection
## Step 2: We want to take leaf biomass and divide it by the time computed in Step 1

```{r}
# for each plot and trap we want to compute the days

litter %>%
  group_by(Plot, Trap) %>% 
  arrange(Date_collected) %>%
  # compute the difference between collection dates. For a series of
  # size n, diff() returns n-1 intervals, so we add one NA at the front
  # because the first date has no elapsed time (since no previous date)
  mutate(elapsed_days = c(NA, diff(Date_collected))) %>% 
  ungroup() %>%
  arrange(Plot, Trap) %>% 
  ## finally compute flux: litter per day
  mutate(All_Leaf_perday = All_Leaf / elapsed_days) ->
  litter

```

## Step 3: We want to interpolate rates between collection dates

```{r}

## to interpolate between two dates, we need to create empty rows
## for example, if we collected on 10/1 and 10/10 right now we only have those rows in our data set
## so we need to create rows from 10/2 . . . 10/9 and then interpolate between the 10/1 flux and 10/10 flux to fill in those rows
## we will use complete() to generate the non-measured intervening dates
## and then we will use zoo::na.approx() to interpolate

# complete() can be work to wrap your head around
# or at least it is for me! Some examples:

library(tidyr)
# Missing group combinations
test <- tibble(group = c("A", "B", "B"),
               level = c(1, 1, 2), 
               values = c(4, 5, 6))
test %>% complete(group, level)

# Missing timepoints
library(zoo)
test <- tibble(time = c(1, 2, 5), values = c(4, 5, 9))
#complete for all time values 1 thru 5
test %>% complete(time = 1:5)
## take the na's and fill in the interpolated values based on pre and post gap values
test %>% complete(time = 1:5) %>% mutate(values=na.approx(values))

#date example
test <- tibble(day = mdy(c("10/20/2021", "10/31/2021")),
               values = c(60, 97))
test %>% complete(day = seq(min(day), max(day), by = "day")) %>% 
  mutate(values=na.approx(values))

# want to group by plot and trap the do above interpolation

litter_test %>%
  group_by(Plot, Trap) %>%
  complete(Date_collected = seq(min(Date_collected), max(Date_collected), by = "day")) %>% 
  mutate(values=na.approx(values))

# Examine: just the control 'A' trap
litter %>% 
  filter(Plot == "C", Trap == "A", year(Date_collected) == 2019) %>% 
  select(Plot, Trap, Date_collected, All_Leaf) ->
  litter_C_A_example

# For today:
# 1. Go over the benefit of working with a small test dataset
# 2. Understand the filter and select steps above
# 3. Use complete() and the zoo::approx() to estimate daily flux over entire year

```


## Step 4: We want to compute cumulative litter fall across the year

## Basic Visualization

```{r basicvis, echo=FALSE}
library(ggplot2)

## plot biomass

ggplot(data = litter, aes(Date_collected, Leaf_LITU, color = Plot)) + geom_point(na.rm = TRUE)

ggplot(data = litter, aes(Date_collected, Leaf_ACRU, color = Plot)) + geom_point(na.rm = TRUE)

ggplot(data = litter, aes(Date_collected, Leaf_FAGR, color = Plot)) + geom_point(na.rm = TRUE)

ggplot(data = litter, aes(Date_collected, Leaf_Other, color = Plot)) + geom_point(na.rm = TRUE)

ggplot(data = litter, aes(Date_collected, All_Leaf, color = Plot)) + geom_point(na.rm = TRUE)

##  plot flux

ggplot(data = litter, aes(Date_collected, All_Leaf_perday, color = Plot)) + geom_point(na.rm = TRUE)

```

## Species average over time

```{r}
library(tidyr)
litter %>%
  group_by(Plot, Date_collected) %>%
  summarise(Leaf_ACRU = mean(Leaf_ACRU, na.rm = TRUE), 
            Leaf_FAGR = mean(Leaf_FAGR, na.rm = TRUE),
            Leaf_LITU = mean(Leaf_LITU, na.rm = TRUE),
            Leaf_Other = mean(Leaf_Other, na.rm = TRUE), .groups = "drop") %>%
  pivot_longer(starts_with("Leaf_")) ->
  litter_smry

ggplot(litter_smry, aes(Date_collected, value, color = Plot)) + geom_line() + facet_grid(name ~ .)

```

## 

